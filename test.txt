import requests
import json
from openpyxl import load_workbook

# JIRA credentials
username = "your_username"
password = "your_password"

# JIRA and Zephyr API endpoints
jira_base_url = "https://your_jira_instance/rest/api/latest"
zephyr_base_url = "https://your_jira_instance/rest/zephyr/latest"

# Function to create a test case in JIRA with Zephyr
def create_test_case(project_key, summary, description):
    # Create issue payload
    issue_payload = {
        "fields": {
            "project": {"key": project_key},
            "summary": summary,
            "description": description,
            "issuetype": {"name": "Test"},
        }
    }

    # Create test case in JIRA
    create_issue_url = f"{jira_base_url}/issue"
    response = requests.post(
        create_issue_url,
        auth=(username, password),
        headers={"Content-Type": "application/json"},
        data=json.dumps(issue_payload),
    )

    if response.status_code == 201:
        issue_key = response.json()["key"]
        print(f"Test case created successfully. Key: {issue_key}")

        # Add the test case to Zephyr
        add_to_zephyr_url = f"{zephyr_base_url}/executions/addTestsToCycle"
        add_to_zephyr_payload = {
            "issues": [issue_key],
            "versionId": -1,  # -1 for the latest version
            "cycleId": "your_cycle_id",  # Replace with your Zephyr cycle ID
        }

        response = requests.post(
            add_to_zephyr_url,
            auth=(username, password),
            headers={"Content-Type": "application/json"},
            data=json.dumps(add_to_zephyr_payload),
        )

        if response.status_code == 200:
            print("Test case added to Zephyr successfully.")
        else:
            print("Failed to add the test case to Zephyr.")
    else:
        print("Failed to create the test case in JIRA.")

# Read test case data from Excel sheet
def read_test_cases_from_excel(file_path, sheet_name):
    workbook = load_workbook(file_path)
    sheet = workbook[sheet_name]

    test_cases = []

    for row in sheet.iter_rows(min_row=2, values_only=True):
        test_case_id = row[0]
        description = row[1]
        steps = row[2]

        test_case = {
            "test_case_id": test_case_id,
            "description": description,
            "steps": steps
        }

        test_cases.append(test_case)

    return test_cases

# Example usage
project_key = "YOUR_PROJECT_KEY"  # Replace with your JIRA project key
excel_file_path = "path_to_your_excel_file.xlsx"
excel_sheet_name = "Sheet1"

# Read test cases from Excel
test_cases = read_test_cases_from_excel(excel_file_path, excel_sheet_name)

# Create test cases in JIRA with Zephyr
for test_case in test_cases:
    summary = test_case["test_case_id"]
    description = test_case["description"]

    create_test_case(project_key, summary, description)
