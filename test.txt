<!DOCTYPE html>
<html>
<head>
    <title>Status Graph</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        #graph {
            width: 800px;
            height: 600px;
            margin: 50px auto;
        }
    </style>
</head>
<body>
    <div id="graph"></div>

    <script>
        // Fetch data from the server-side variable
        var data = {{ data | safe }};

        // Extract unique endpoint names
        var endpoints = [...new Set(data.map(item => item.name))];

        // Initialize an empty list for traces
        var traces = [];

        // Loop through each endpoint and create a trace
        endpoints.forEach(endpoint => {
            // Filter data for the current endpoint
            var filteredData = data.filter(item => item.name === endpoint);

            // Extract x and y values from the filtered data
            var x = filteredData.map(item => item.timestamp);
            var y = filteredData.map(item => item.status === "Pass" ? "✓" : "✕");

            // Create the trace for the current endpoint
            var trace = {
                x: x,
                y: y,
                mode: 'markers',
                marker: {
                    size: 12,
                    color: y.map(status => status === "✓" ? "green" : "red"),
                },
                text: x.map((timestamp, index) => `${endpoint}<br>Status: ${y[index]}<br>Timestamp: ${timestamp}`),
                hovertemplate: '%{text}<extra></extra>',
                name: endpoint,
            };

            // Add the trace to the list
            traces.push(trace);
        });

        // Set the layout options
        var layout = {
            title: 'Status Graph',
            xaxis: {
                type: 'date',
                tickformat: '%Y-%m-%d %H:%M:%S',
                range: [data[0].timestamp, data[data.length - 1].timestamp],
                tickangle: -45,
            },
            yaxis: {
                ticktext: endpoints,
                tickvals: Array.from(Array(endpoints.length).keys()),
                automargin: true,
                tickangle: -45,
                tickfont: {
                    size: 12,
                },
            },
            hovermode: 'closest',
        };

        // Create the plot
        Plotly.newPlot('graph', traces, layout);

        // Make the y-axis scrollable
        var graphDiv = document.getElementById('graph');
        graphDiv.onwheel = function(event) {
            var xaxis = graphDiv._fullLayout.xaxis;
            var range = xaxis.range;
            var span = range[1] - range[0];
            var scrollAmount = event.deltaY * span / graphDiv.clientWidth;
            var newRange = [range[0] + scrollAmount, range[1] + scrollAmount];
            Plotly.relayout(graphDiv, {xaxis: {range: newRange}});
        };
    </script>
</body>
</html>
